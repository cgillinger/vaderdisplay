/**
 * SVG Icon Loader for Flask Weather Dashboard - FIXAD VERSION
 * FAS 3: amCharts Animated Icons Integration
 * 
 * OPTIMERAD F√ñR: LP156WH4 (1366√ó768) + Pi5 + Chromium kiosk-l√§ge
 * FUNKTIONER: Laddar amCharts SVG-ikoner baserat p√• SMHI weather symbols
 * FALLBACK: Automatisk √•terg√•ng till Weather Icons om SVG saknas
 * PRESTANDA: Cache och optimerad f√∂r Pi5 GPU
 * 
 * üîß FIXAR:
 * - ‚úÖ R√§tt BASE_PATH: /static/assets/icons/amcharts-svg/
 * - ‚úÖ Komplett SMHI symbol mapping (1-27)
 * - ‚úÖ Korrekt window-exponering (HUVUDFIXET)
 * - ‚úÖ F√∂renklad config utan API-beroende
 */

// === SMHI WEATHER SYMBOL MAPPING ===
const SMHI_TO_SVG_MAPPING = {
    // Klart v√§der
    1: { day: 'clear-day.svg', night: 'clear-night.svg' },
    2: { day: 'partly-cloudy-day.svg', night: 'partly-cloudy-night.svg' },
    
    // Molnigt v√§der
    3: { day: 'partly-cloudy-day-2.svg', night: 'partly-cloudy-night-2.svg' },
    4: { day: 'partly-cloudy-day-3.svg', night: 'partly-cloudy-night-3.svg' },
    5: { day: 'cloudy.svg', night: 'cloudy.svg' },
    6: { day: 'overcast.svg', night: 'overcast.svg' },
    7: { day: 'fog.svg', night: 'fog.svg' },
    
    // Regnskurar
    8: { day: 'partly-cloudy-day-drizzle.svg', night: 'partly-cloudy-night-drizzle.svg' },
    9: { day: 'partly-cloudy-day-rain.svg', night: 'partly-cloudy-night-rain.svg' },
    10: { day: 'rain.svg', night: 'rain.svg' },
    
    // √Öska
    11: { day: 'thunderstorms-day.svg', night: 'thunderstorms-night.svg' },
    21: { day: 'thunderstorms.svg', night: 'thunderstorms.svg' },
    
    // Sn√∂blandat regn
    12: { day: 'partly-cloudy-day-sleet.svg', night: 'partly-cloudy-night-sleet.svg' },
    13: { day: 'sleet.svg', night: 'sleet.svg' },
    14: { day: 'sleet.svg', night: 'sleet.svg' },
    22: { day: 'sleet.svg', night: 'sleet.svg' },
    23: { day: 'sleet.svg', night: 'sleet.svg' },
    24: { day: 'sleet.svg', night: 'sleet.svg' },
    
    // Sn√∂byar
    15: { day: 'partly-cloudy-day-snow.svg', night: 'partly-cloudy-night-snow.svg' },
    16: { day: 'snow.svg', night: 'snow.svg' },
    17: { day: 'snow.svg', night: 'snow.svg' },
    25: { day: 'snow.svg', night: 'snow.svg' },
    26: { day: 'snow.svg', night: 'snow.svg' },
    27: { day: 'snow.svg', night: 'snow.svg' },
    
    // Regn
    18: { day: 'partly-cloudy-day-rain.svg', night: 'partly-cloudy-night-rain.svg' },
    19: { day: 'rain.svg', night: 'rain.svg' },
    20: { day: 'rain.svg', night: 'rain.svg' }
};

// === DEFAULT KONFIGURATION ===
const DEFAULT_CONFIG = {
    enabled: true,
    base_path: '/static/assets/icons/amcharts-svg',  // üîß FIX: R√§tt s√∂kv√§g
    day_path: 'day',
    night_path: 'night',
    fallback_to_static: true,
    debug_logging: false,
    icon_sizes: {
        main_weather: '89px',
        forecast_hourly: '48px',
        forecast_daily: '30px',
        details: '21px'
    },
    symbol_mapping: SMHI_TO_SVG_MAPPING  // üîß FIX: Komplett mapping
};

// === GLOBAL STATE ===
let svgIconLoader = null;

// === HUVUDKLASS: SVG ICON LOADER ===
class SVGIconLoader {
    constructor() {
        this.config = { ...DEFAULT_CONFIG };  // üîß FIX: Anv√§nd enkel config
        this.cache = new Map();
        this.preloadedIcons = new Set();
        this.isInitialized = false;
        this.debugLogging = false;
        
        this.log('SVGIconLoader initialiserad med fixad konfiguration');
    }
    
    /**
     * Initialisera SVG Icon Loader
     */
    async initialize() {
        try {
            this.log('Initialiserar SVG Icon Loader...');
            
            // üîß FIX: Enkel initialisering utan API-beroende
            this.debugLogging = this.config.debug_logging;
            this.isInitialized = true;
            
            this.log('SVG Icon Loader initialisering klar');
            return true;
            
        } catch (error) {
            this.logError('Fel vid initialisering:', error);
            return false;
        }
    }
    
    /**
     * Kontrollera om animerade ikoner √§r aktiverade
     */
    isAnimatedIconsEnabled() {
        return this.config && this.config.enabled === true;
    }
    
    /**
     * Ladda och visa SVG-ikon f√∂r givet weather symbol
     */
    async loadIcon(weatherSymbol, isDay = true, targetElement = null, size = null) {
        if (!this.isInitialized || !this.isAnimatedIconsEnabled()) {
            this.log('SVG loader ej initialiserad eller inaktiverat - anv√§nder fallback');
            return this.createFallbackResult(weatherSymbol, isDay, 'loader_not_ready');
        }
        
        try {
            const cacheKey = this.getCacheKey(weatherSymbol, isDay);
            let svgContent = this.cache.get(cacheKey);
            
            // H√§mta fr√•n cache eller ladda ny
            if (!svgContent) {
                svgContent = await this.fetchIcon(weatherSymbol, isDay);
                if (svgContent) {
                    this.cache.set(cacheKey, svgContent);
                }
            }
            
            if (svgContent) {
                const element = this.createSVGElement(svgContent, weatherSymbol, size, targetElement);
                const iconPath = this.getIconPath(weatherSymbol, isDay);
                
                // üîß FIX: Returnera strukturerat svar f√∂r dashboard.js
                return {
                    success: true,
                    element: element,
                    source: 'amcharts_svg',
                    iconPath: iconPath,
                    cached: this.cache.has(cacheKey)
                };
            } else {
                this.log(`SVG-ikon kunde inte laddas f√∂r symbol ${weatherSymbol}`);
                return this.createFallbackResult(weatherSymbol, isDay, 'svg_load_failed');
            }
            
        } catch (error) {
            this.logError('Fel vid ikondladdning:', error);
            return this.createFallbackResult(weatherSymbol, isDay, 'load_error');
        }
    }
    
    /**
     * H√§mta SVG-inneh√•ll f√∂r specifik ikon
     */
    async fetchIcon(weatherSymbol, isDay) {
        const iconPath = this.getIconPath(weatherSymbol, isDay);
        const iconUrl = this.buildIconUrl(iconPath, isDay);
        
        try {
            this.log(`H√§mtar SVG fr√•n: ${iconUrl}`);
            
            const response = await fetch(iconUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const svgContent = await response.text();
            this.log(`SVG-inneh√•ll h√§mtat (${svgContent.length} tecken)`);
            
            return svgContent;
            
        } catch (error) {
            this.logError(`Fel vid h√§mtning av ${iconUrl}:`, error);
            return null;
        }
    }
    
    /**
     * F√• ikons√∂kv√§g f√∂r SMHI weather symbol
     */
    getIconPath(weatherSymbol, isDay) {
        const symbol = parseInt(weatherSymbol);
        const mapping = this.config.symbol_mapping[symbol];
        
        if (!mapping) {
            this.log(`Ok√§nd weather symbol: ${symbol}, anv√§nder fallback`);
            return 'unknown.svg';
        }
        
        return isDay ? mapping.day : mapping.night;
    }
    
    /**
     * Bygg fullst√§ndig URL f√∂r ikon
     */
    buildIconUrl(iconPath, isDay) {
        const basePath = this.config.base_path;
        const subPath = isDay ? this.config.day_path : this.config.night_path;
        
        // üîß FIX: Enkel URL-byggning
        const fullUrl = `${basePath}/${subPath}/${iconPath}`;
        return fullUrl;
    }
    
    /**
     * Skapa SVG DOM-element fr√•n SVG-inneh√•ll
     */
    createSVGElement(svgContent, weatherSymbol, customSize = null, targetElement = null) {
        // Skapa container-div
        const container = document.createElement('div');
        container.className = 'animated-weather-icon';
        container.innerHTML = svgContent.trim();
        
        const svgElement = container.querySelector('svg');
        if (!svgElement) {
            this.logError('Inget SVG-element hittades i inneh√•llet');
            return null;
        }
        
        // S√§tt storlek
        const size = customSize || this.config.icon_sizes?.main_weather || '89px';
        svgElement.style.width = size;
        svgElement.style.height = size;
        
        // LP156WH4 optimeringar
        svgElement.style.display = 'block';
        svgElement.style.margin = '0 auto';
        
        // S√§tt CSS-klasser f√∂r styling
        svgElement.classList.add('animated-svg-icon');
        svgElement.classList.add('weather-main-icon');  // üîß FIX: Samma klass som Weather Icons
        svgElement.classList.add(`weather-symbol-${weatherSymbol}`);
        
        // Om targetElement anges, ers√§tt inneh√•llet
        if (targetElement) {
            targetElement.innerHTML = '';
            targetElement.appendChild(container);
            this.log(`SVG ikon renderad i target element f√∂r symbol ${weatherSymbol}`);
        }
        
        this.log(`SVG element skapat f√∂r symbol ${weatherSymbol} (storlek: ${size})`);
        return container;
    }
    
    /**
     * üîß FIX: Skapa strukturerat fallback-resultat
     */
    createFallbackResult(weatherSymbol, isDay, reason) {
        return {
            success: false,
            element: null,
            source: 'fallback_needed',
            error: reason,
            weatherSymbol: weatherSymbol,
            isDay: isDay
        };
    }
    
    /**
     * F√• cache-nyckel f√∂r ikon
     */
    getCacheKey(weatherSymbol, isDay) {
        return `${weatherSymbol}_${isDay ? 'day' : 'night'}`;
    }
    
    /**
     * Rensa cache
     */
    clearCache() {
        this.cache.clear();
        this.preloadedIcons.clear();
        this.log('SVG Icon cache rensad');
    }
    
    /**
     * F√• cache-statistik f√∂r debugging
     */
    getCacheStats() {
        return {
            cachedIcons: this.cache.size,
            preloadedIcons: this.preloadedIcons.size,
            memoryUsage: this.estimateMemoryUsage()
        };
    }
    
    /**
     * Uppskatta minnesanv√§ndning
     */
    estimateMemoryUsage() {
        let totalSize = 0;
        for (const [key, content] of this.cache) {
            totalSize += key.length * 2;
            totalSize += content.length * 2;
        }
        return `${Math.round(totalSize / 1024)} KB`;
    }
    
    /**
     * F√∂rst√∂r loader och rensa resurser
     */
    destroy() {
        this.clearCache();
        this.config = null;
        this.isInitialized = false;
        this.log('SVGIconLoader f√∂rst√∂rd');
    }
    
    /**
     * Logging-helper
     */
    log(message) {
        if (this.debugLogging) {
            console.log(`[SVGIconLoader] ${message}`);
        }
    }
    
    /**
     * Error logging-helper
     */
    logError(message, error) {
        console.error(`[SVGIconLoader] ${message}`, error);
    }
}

// === CONVENIENCE FUNCTIONS ===

/**
 * Globalt tillg√§nglig funktion f√∂r att ladda animerad ikon
 */
async function loadAnimatedIcon(weatherSymbol, isDay = true, targetElement = null, size = null) {
    if (!svgIconLoader) {
        console.warn('[SVGIconLoader] Loader ej initialiserad - initialiserar nu...');
        await initializeSVGLoader();
    }
    
    if (svgIconLoader && svgIconLoader.isInitialized) {
        return await svgIconLoader.loadIcon(weatherSymbol, isDay, targetElement, size);
    } else {
        console.warn('[SVGIconLoader] Fallback till statiska ikoner');
        return {
            success: false,
            element: null,
            source: 'initialization_failed',
            error: 'SVG loader could not be initialized'
        };
    }
}

/**
 * Kontrollera om animerade ikoner √§r aktiverade
 */
function isAnimatedIconsEnabled() {
    return svgIconLoader && svgIconLoader.isInitialized && svgIconLoader.isAnimatedIconsEnabled();
}

/**
 * F√• cache-statistik f√∂r debugging
 */
function getSVGIconCacheStats() {
    return svgIconLoader ? svgIconLoader.getCacheStats() : null;
}

/**
 * Rensa SVG-cache
 */
function clearSVGIconCache() {
    if (svgIconLoader) {
        svgIconLoader.clearCache();
    }
}

// === GLOBAL INITIALIZATION ===

/**
 * üîß FIX: Initialisera SVG Icon Loader (f√∂renklad)
 */
async function initializeSVGLoader() {
    try {
        console.log('[SVGIconLoader] Initialiserar fixad SVG Icon Loader...');
        
        if (svgIconLoader) {
            svgIconLoader.destroy();
        }
        
        svgIconLoader = new SVGIconLoader();
        const success = await svgIconLoader.initialize();
        
        if (success) {
            // üîß FIX: Korrekt exponering till global scope (HUVUDFIXET)
            window.SVGIconLoader = SVGIconLoader;           // ‚úÖ Klass
            window.svgIconLoader = svgIconLoader;           // ‚úÖ Instans
            window.loadAnimatedIcon = loadAnimatedIcon;     // ‚úÖ Huvudfunktion
            window.isAnimatedIconsEnabled = isAnimatedIconsEnabled;  // ‚úÖ Status
            window.initializeSVGLoader = initializeSVGLoader;        // ‚úÖ Init
            window.getSVGIconCacheStats = getSVGIconCacheStats;      // ‚úÖ Debug
            window.clearSVGIconCache = clearSVGIconCache;            // ‚úÖ Rensa
            
            console.log('[SVGIconLoader] ‚úÖ Initialisering lyckades - funktioner exponerade p√• window');
            console.log('[SVGIconLoader] ‚úÖ Tillg√§ngliga funktioner: SVGIconLoader, svgIconLoader, loadAnimatedIcon, isAnimatedIconsEnabled, initializeSVGLoader');
            return true;
        } else {
            console.log('[SVGIconLoader] ‚ùå Initialisering misslyckades');
            return false;
        }
        
    } catch (error) {
        console.error('[SVGIconLoader] ‚ùå Fel vid initialisering:', error);
        return false;
    }
}

// === AUTO-INITIALIZATION ===

/**
 * Auto-initialisera n√§r DOM √§r redo
 */
document.addEventListener('DOMContentLoaded', function() {
    // V√§nta lite s√• dashboard.js hinner ladda f√∂rst
    setTimeout(async () => {
        if (!svgIconLoader) {
            await initializeSVGLoader();
        }
    }, 100);
});

// === ERROR HANDLING ===

window.addEventListener('error', function(event) {
    if (event.message && event.message.includes('SVGIconLoader')) {
        console.error('[SVGIconLoader] JavaScript fel f√•ngat:', event.error);
    }
});

// === EXPORTS F√ñR MODULARITY ===
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        SVGIconLoader,
        loadAnimatedIcon,
        isAnimatedIconsEnabled,
        initializeSVGLoader
    };
}

console.log('[SVGIconLoader] üé¨ FIXAD amCharts SVG Icon Loader modul laddad - window-exponering KORRIGERAD!');